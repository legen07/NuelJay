import{optimize as d}from"svgo";import{readFile as l,writeFile as m}from"node:fs/promises";import{getSvgoOptions as f}from"./utils.js";import{parseString as h}from"xml2js";async function p(a){return await new Promise((n,o)=>{h(a,(r,s)=>{if(r){o(r);return}const e=s.svg,t={width:e.$.width,height:e.$.height,viewBox:e.$.viewBox};if((!t.width||!t.height)&&t.viewBox){const i=t.viewBox.split(" ");i.length===4&&(t.width=i[2],t.height=i[3])}if(e.title&&e.title.length>0&&(t.title=e.title[0]),e.desc&&e.desc.length>0&&(t.description=e.desc[0]),e.metadata&&e.metadata.length>0){const i=e.metadata[0];for(const c in i){if(c==="$")continue;const g=i[c][0];switch(c){case"author":t.author=g;break;case"creationdate":t.creationDate=g;break;case"copyright":t.copyright=g;break;case"softwareused":t.softwareUsed=g;break;default:t.customMetadata||(t.customMetadata=[]),t.customMetadata.push(`${c}: ${g}`);break}}}for(const i in t)t[i]||delete t[i];const u=Object.keys(e).length-1;n({metadata:t,itemCount:u})})})}function w(a,n){const o=d(a,n);if(!o.data)throw new Error("Failed to optimize SVG");return o.data}async function C(a,n,o){const r=await l(a,"utf8"),s=w(r,f(o.plugins)),{metadata:e,itemCount:t}=await p(s);return m(n,s,"utf8").then(()=>({originalSize:r.length,size:s.length,src:a,dist:n,metadata:e,itemCount:t}))}export{C as encodeSvg,w as optimizeSvg};
